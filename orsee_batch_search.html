<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>ORSEE participant batch search</title>
<style>
body { font-family: system-ui, sans-serif; max-width: 900px; margin: 24px auto; }
textarea { width: 100%; height: 160px; }
input[type=text], input[type=number] { width: 100%; }
button { margin-right: 8px; }
button:disabled { opacity: 0.4; cursor: not-allowed; }
pre { background:#111; color:#ddd; padding:12px; }
.batch { font-weight: bold; margin-top: 10px; }
</style>
</head>
<body>

<h2>ORSEE participant batch search</h2>

<p>
Target URL:
<input type="text" id="target"
 value="https://orsee.krannert.purdue.edu/admin/participants_show.php">
</p>

<p>
Upload text or CSV file (one participant per line):
<input type="file" id="csv" accept=".csv,.txt,text/plain,text/csv">
</p>

<p>Or paste text (one participant per line):</p>
<textarea id="input"></textarea>

<p>
Batch size:
<input type="number" id="batchSize" value="40" min="1">
</p>

<button onclick="loadTokens()">Load tokens</button>
<button id="prevBtn" onclick="prev()">Prev batch</button>
<button id="nextBtn" onclick="next()">Next batch</button>
<button onclick="openBatch()">Open batch in ORSEE</button>

<div id="batchInfo" class="batch"></div>
<pre id="preview"></pre>

<form id="form" method="post" target="_blank" style="display:none;"></form>

<script>
let tokens = [];
let idx = 0;

const batchInfo = document.getElementById("batchInfo");
const preview   = document.getElementById("preview");
const prevBtn   = document.getElementById("prevBtn");
const nextBtn   = document.getElementById("nextBtn");

function extractTokens(text){
  return [...new Set(
    text.split(/\r?\n/).map(s => s.trim()).filter(Boolean)
  )];
}

document.getElementById("csv").addEventListener("change", async (e) => {
  const file = e.target.files[0];
  if (!file) return;
  document.getElementById("input").value = await file.text();
});

function batchSizeVal(){
  return +document.getElementById("batchSize").value;
}

function totalBatches(){
  return Math.ceil(tokens.length / batchSizeVal());
}

function currentBatch(){
  return Math.floor(idx / batchSizeVal()) + 1;
}

function batch(){
  return tokens.slice(idx, idx + batchSizeVal());
}

function loadTokens(){
  tokens = extractTokens(document.getElementById("input").value);
  idx = 0;
  update();
}

function update(){
  if (tokens.length === 0) {
    batchInfo.textContent = "No tokens loaded.";
    preview.textContent = "";
    prevBtn.disabled = true;
    nextBtn.disabled = true;
    return;
  }

  const b = batch();
  const cur = currentBatch();
  const total = totalBatches();

  batchInfo.textContent =
    `Current batch: ${cur} of ${total} (tokens ${idx + 1}â€“${idx + b.length})`;

  preview.textContent = b.join("\n");

  prevBtn.disabled = (cur === 1);
  nextBtn.disabled = (cur === total);
}

function next(){
  idx = Math.min(idx + batchSizeVal(), tokens.length);
  update();
}

function prev(){
  idx = Math.max(0, idx - batchSizeVal());
  update();
}

function h(n,v){
  const i=document.createElement("input");
  i.type="hidden"; i.name=n; i.value=v; return i;
}

function openBatch(){
  const b = batch();
  const f = document.getElementById("form");
  f.innerHTML = "";
  f.action = document.getElementById("target").value;
  f.method = "post";

  let i = 0;
  f.appendChild(h(`form[query][${i}][bracket_open][type]`,"open")); i++;

  b.forEach(t=>{
    if(i>1) f.appendChild(h(
      `form[query][${i}][pformtextfields_freetextsearch][logical_op]`,"or"
    ));
    f.appendChild(h(
      `form[query][${i}][pformtextfields_freetextsearch][search_string]`,t
    ));
    f.appendChild(h(
      `form[query][${i}][pformtextfields_freetextsearch][search_field]`,"all"
    ));
    f.appendChild(h(
      `form[query][${i}][pformtextfields_freetextsearch][not]`,""
    ));
    i++;
  });

  f.appendChild(h(`form[query][${i}][bracket_close][type]`,"close")); i++;

  f.appendChild(h(
    `form[query][${i}][statusids_multiselect][logical_op]`,"and"
  ));
  f.appendChild(h(
    `form[query][${i}][statusids_multiselect][ms_status]`,"1"
  ));

  f.appendChild(h("search_submit","true"));
  f.submit();
}
</script>

</body>
</html>
